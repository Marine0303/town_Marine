<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>建築ガチ勢</title>
<style>
html,body{margin:0;height:100%;background:#050b1a;color:#e9eefc;font-family:system-ui;overflow:hidden}
header{
  position:fixed;top:0;left:0;right:0;z-index:10;
  background:rgba(8,14,34,.92);backdrop-filter:blur(8px);
  padding:10px;border-bottom:1px solid rgba(255,255,255,.1)
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,input{
  background:#0f1b44;color:#fff;border:1px solid rgba(255,255,255,.2);
  border-radius:10px;padding:8px 10px;font-size:13px
}
button.primary{background:#2b7cff;font-weight:700}
label{font-size:12px;opacity:.8}
#c{position:fixed;top:72px;left:0;right:0;bottom:0;touch-action:none}

.panel{
  position:fixed;top:80px;left:10px;right:10px;
  background:rgba(10,16,40,.96);border:1px solid rgba(255,255,255,.12);
  border-radius:16px;padding:12px;display:none;z-index:20
}
.panel.open{display:block}
.effect{display:flex;justify-content:space-between;align-items:center;
  padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  margin-bottom:6px}
.dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>

<header>
  <div class="row">
    <strong>WOS 旗ルート</strong>
    <label>HQ X</label><input id="hqX" type="number" value="520" style="width:70px">
    <label>HQ Y</label><input id="hqY" type="number" value="520" style="width:70px">
    <button id="applyHQ">HQ反映</button>
    <button id="openEff">効果選択</button>
    <button id="build" class="primary">ルート作成</button>
    <button id="reset">リセット</button>
  </div>
</header>

<canvas id="c"></canvas>

<div id="effPanel" class="panel">
  <strong>欲しい効果（重複不可）</strong>
  <div id="effList"></div>
  <button onclick="effPanel.classList.remove('open')">閉じる</button>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const SCALE = 0.6;
const TILE = 18;
const cam = {x:0,y:0,s:1};
const BASE = {x:0,y:0};

const SUN = {x:597,y:597};

const STATIONS_RAW = [
 [138,327],[138,957],[237,138],[327,1038],[768,138],[957,1068],
 [1068,237],[1068,747],[87,666],[138,237],[267,1068],[537,87],
 [636,1137],[957,138],[1068,936],[1137,567],[138,138],[138,666],
 [138,1038],[537,138],[666,1068],[1068,138],[1068,567],[1068,1068],
 [327,666],[486,327],[768,867],[867,567],[237,237],[237,957],
 [267,537],[537,936],[666,267],[957,237],[936,537],[957,957],
 [327,327],[327,867],[867,327],[867,867],[138,747],[237,486],
 [486,138],[486,957],[768,237],[768,1038],[957,747],[1068,486],
 [138,438],[138,867],[366,138],[438,1068],[666,138],[738,957],
 [957,438],[1068,666],[387,486],[588,867],[816,486],[387,717],
 [588,327],[816,717],[327,567],[486,867],[768,327],[867,666]
];

const EFFECTS = [
 {id:"prod",name:"生産",c:"#34d399"},
 {id:"gath",name:"採取",c:"#a3e635"},
 {id:"march",name:"行軍速度",c:"#60a5fa"},
 {id:"atk8",name:"攻撃8%",c:"#ef4444"},
 {id:"def8",name:"防御8%",c:"#f59e0b"},
 {id:"res8",name:"研究8%",c:"#8b5cf6"},
 {id:"build8",name:"建築8%",c:"#0ea5e9"}
];

const stations = STATIONS_RAW.map(([x,y],i)=>({
 id:i+1,x,y,effect:EFFECTS[i%EFFECTS.length].id
}));

const selectedEffects = new Set();
let chosenStations = [];
let edges = [];

let hq = {x:520,y:520};

function iso(x,y){return{sx:(x-y)*SCALE,sy:(x+y)*SCALE*0.5}}
function d2(a,b){return (a.x-b.x)**2+(a.y-b.y)**2}

function resize(){
 const r=canvas.getBoundingClientRect();
 canvas.width=r.width*devicePixelRatio;
 canvas.height=r.height*devicePixelRatio;
 ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
 BASE.x=r.width/2;BASE.y=r.height/2;
}
window.addEventListener("resize",resize);resize();

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.save();
 ctx.translate(BASE.x+cam.x,BASE.y+cam.y);
 ctx.scale(cam.s,cam.s);

 // 背景
 ctx.fillStyle="#071021";
 ctx.fillRect(-2000,-2000,4000,4000);

 // ステ
 for(const s of stations){
   const p=iso(s.x,s.y);
   ctx.fillStyle="rgba(255,255,255,.25)";
   ctx.beginPath();ctx.arc(p.sx,p.sy,2.5,0,Math.PI*2);ctx.fill();
 }

 // 太陽城
 const sp=iso(SUN.x,SUN.y);
 ctx.fillStyle="#facc15";
 ctx.beginPath();ctx.arc(sp.sx,sp.sy,8,0,Math.PI*2);ctx.fill();

 // ルート線
 ctx.strokeStyle="#2b7cff";ctx.lineWidth=3;
 for(const e of edges){
   const a=iso(e.a.x,e.a.y),b=iso(e.b.x,e.b.y);
   ctx.beginPath();ctx.moveTo(a.sx,a.sy);ctx.lineTo(b.sx,b.sy);ctx.stroke();
 }

 // HQ
 const hp=iso(hq.x,hq.y);
 ctx.fillStyle="#2b7cff";
 ctx.beginPath();ctx.arc(hp.sx,hp.sy,7,0,Math.PI*2);ctx.fill();

 // 選択ステ
 for(const s of chosenStations){
   const p=iso(s.x,s.y);
   ctx.fillStyle="#ff3b3b";
   ctx.beginPath();ctx.arc(p.sx,p.sy,5,0,Math.PI*2);ctx.fill();
 }

 ctx.restore();
}

function chooseStations(){
 chosenStations=[];
 for(const eff of selectedEffects){
   const cands=stations.filter(s=>s.effect===eff);
   let best=cands[0],bd=d2(hq,best);
   for(const s of cands){
     const d=d2(hq,s);
     if(d<bd){bd=d;best=s}
   }
   chosenStations.push(best);
 }
}

function buildRoute(){
 edges=[];
 const nodes=[hq,...chosenStations];
 const used=new Set([0]);
 const best=Array(nodes.length);
 for(let i=1;i<nodes.length;i++)best[i]={from:0,d:d2(nodes[0],nodes[i])};
 while(used.size<nodes.length){
   let pick=-1,bd=Infinity;
   for(let i=1;i<nodes.length;i++)
     if(!used.has(i)&&best[i].d<bd){bd=best[i].d;pick=i}
   if(pick<0)break;
   used.add(pick);
   edges.push({a:nodes[best[pick].from],b:nodes[pick]});
   for(let i=1;i<nodes.length;i++){
     if(!used.has(i)){
       const d=d2(nodes[pick],nodes[i]);
       if(d<best[i].d)best[i]={from:pick,d};
     }
   }
 }
}

document.getElementById("build").onclick=()=>{
 chooseStations();
 buildRoute();
 draw();
};

document.getElementById("applyHQ").onclick=()=>{
 hq.x=+hqX.value;hq.y=+hqY.value;draw();
};

document.getElementById("reset").onclick=()=>{
 selectedEffects.clear();chosenStations=[];edges=[];draw();
};

const effPanel=document.getElementById("effPanel");
const effList=document.getElementById("effList");
document.getElementById("openEff").onclick=()=>{
 effList.innerHTML="";
 for(const e of EFFECTS){
   const d=document.createElement("div");
   d.className="effect";
   d.innerHTML=`<label><input type="checkbox"> ${e.name}</label>
     <span class="dot" style="background:${e.c}"></span>`;
   const chk=d.querySelector("input");
   chk.checked=selectedEffects.has(e.id);
   chk.onchange=()=>chk.checked?selectedEffects.add(e.id):selectedEffects.delete(e.id);
   effList.appendChild(d);
 }
 effPanel.classList.add("open");
};

function centerSun(){
 const p=iso(SUN.x,SUN.y);
 cam.x=-p.sx*cam.s;cam.y=-p.sy*cam.s;
}
centerSun();draw();

// pan/zoom
let last=null;
canvas.addEventListener("pointerdown",e=>{last={x:e.clientX,y:e.clientY}});
canvas.addEventListener("pointermove",e=>{
 if(!last)return;
 cam.x+=e.clientX-last.x;
 cam.y+=e.clientY-last.y;
 last={x:e.clientX,y:e.clientY};
 draw();
});
canvas.addEventListener("pointerup",()=>last=null);
canvas.addEventListener("wheel",e=>{
 cam.s*=e.deltaY>0?0.9:1.1;
 cam.s=Math.max(0.4,Math.min(3,cam.s));
 draw();
});
</script>
</body>
</html>