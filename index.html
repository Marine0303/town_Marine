<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>WOS シミュレーションマップ</title>

<style>
:root{
  --headerH: 72px;
}
html,body{
  margin:0;
  height:100dvh;
  background:#050b1a;
  color:#e9eefc;
  font-family:system-ui;
  overflow:hidden;
}

/* ===== Header ===== */
header{
  position:fixed;
  left:0; right:0; top:0;
  z-index:10;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  padding:10px;
  padding-top:calc(10px + env(safe-area-inset-top));
  background:rgba(10,16,40,.92);
  border-bottom:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(8px);
}
.pill{
  padding:6px 12px;
  border:1px solid rgba(255,255,255,.18);
  border-radius:999px;
  background:#0b1433;
}
button,input{
  background:#0f1b44;
  color:#e9eefc;
  border:1px solid rgba(255,255,255,.18);
  border-radius:10px;
  padding:8px 10px;
  font-size:14px;
}
button{cursor:pointer}
.mini{font-size:12px;opacity:.85}

/* ===== Canvas ===== */
#c{
  position:fixed;
  left:0;
  top:var(--headerH);
  width:100vw;
  height:calc(100dvh - var(--headerH)); /* ← 高さをCSSで保証 */
  touch-action:none;
}
</style>
</head>

<body>

<header id="hdr">
  <span class="pill">WOS シミュレーション</span>

  <span class="mini">HQ</span>
  <input id="hqLabel" value="N9Q HQ" style="width:110px">
  <input id="hqColor" type="color" value="#2b7cff">

  <span class="mini">旗距離</span>
  <input id="maxDist" type="number" value="300" style="width:80px">

  <button id="addHQ">HQ追加</button>
  <button id="reset">表示リセット</button>
</header>

<canvas id="c"></canvas>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const hdr = document.getElementById("hdr");

  /* ===== パラメータ ===== */
  const SCALE = 0.8;
  const TILE_W = 40;
  const TILE_H = 20;
  const WORLD_MIN = 0;
  const WORLD_MAX = 1200;

  /* ===== カメラ ===== */
  const cam = { x:0, y:0, s:1 };
  const BASE = { x:0, y:0 };

  /* ===== 固定施設 ===== */
  const SUN = { x:597, y:597 };

  const FIXED = [
    { type:"sun", x:597, y:597, label:"SUN" },

    { type:"fortress", x:597, y:800, label:"要塞1" },
    { type:"fortress", x:400, y:597, label:"要塞2" },
    { type:"fortress", x:597, y:400, label:"要塞3" },
    { type:"fortress", x:800, y:597, label:"要塞4" },

    { type:"fort", x:237, y:828 },
    { type:"fort", x:237, y:606 },
    { type:"fort", x:237, y:348 },
    { type:"fort", x:366, y:237 },
    { type:"fort", x:588, y:137 },
    { type:"fort", x:846, y:237 },
    { type:"fort", x:957, y:348 },
    { type:"fort", x:957, y:606 },
    { type:"fort", x:957, y:828 },
    { type:"fort", x:846, y:957 },
    { type:"fort", x:606, y:957 },
    { type:"fort", x:306, y:957 },
  ];

  /* ===== ステーション74 ===== */
  const STATIONS = [
    [138,327],[138,957],[237,138],[327,1038],[768,138],[957,1068],
    [1068,237],[1068,747],[87,666],[138,237],[267,1068],[537,87],
    [636,1137],[957,138],[1068,936],[1137,567],[138,138],[138,666],
    [138,1038],[537,138],[666,1068],[1068,138],[1068,567],[1068,1068],
    [327,666],[486,327],[768,867],[867,567],[237,237],[237,957],
    [267,537],[537,936],[666,267],[957,237],[936,537],[957,957],
    [327,327],[327,867],[867,327],[867,867],[138,747],[237,486],
    [486,138],[486,957],[768,237],[768,1038],[957,747],[1068,486],
    [138,438],[138,867],[366,138],[438,1068],[666,138],[738,957],
    [957,438],[1068,666],[387,486],[588,867],[816,486],[387,717],
    [588,327],[816,717],[327,567],[486,867],[768,327],[867,666]
  ].map(([x,y])=>({x,y}));

  /* ===== HQ ===== */
  let hqs = [
    { id:1, x:520, y:520, label:"N9Q HQ", color:"#2b7cff" }
  ];
  let nextHqId = 2;

  /* ===== ユーティリティ ===== */
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const iso = (x,y)=>({ sx:(x-y)*SCALE, sy:(x+y)*SCALE*0.5 });

  /* ===== Canvasサイズ ===== */
  function updateHeaderHeight(){
    document.documentElement.style.setProperty(
      "--headerH",
      `${Math.ceil(hdr.getBoundingClientRect().height)}px`
    );
  }
  function resize(){
    updateHeaderHeight();
    const r = canvas.getBoundingClientRect();
    const w = Math.max(1, Math.floor(r.width * devicePixelRatio));
    const h = Math.max(1, Math.floor(r.height * devicePixelRatio));
    canvas.width = w;
    canvas.height = h;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }

  /* ===== 描画 ===== */
  function drawGround(){
    ctx.fillStyle="#070f28";
    ctx.fillRect(-99999,-99999,199998,199998);
    ctx.strokeStyle="rgba(255,255,255,.06)";
    for(let y=0;y<=1200;y+=20){
      for(let x=0;x<=1200;x+=20){
        const p=iso(x,y);
        ctx.fillStyle="rgba(180,220,255,.12)";
        ctx.beginPath();
        ctx.moveTo(p.sx,p.sy);
        ctx.lineTo(p.sx+TILE_W/2,p.sy+TILE_H/2);
        ctx.lineTo(p.sx,p.sy+TILE_H);
        ctx.lineTo(p.sx-TILE_W/2,p.sy+TILE_H/2);
        ctx.closePath();
        ctx.fill();ctx.stroke();
      }
    }
  }

  function draw(){
    resize();
    const r = canvas.getBoundingClientRect();
    BASE.x = r.width/2;
    BASE.y = r.height/2;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(BASE.x+cam.x, BASE.y+cam.y);
    ctx.scale(cam.s, cam.s);

    drawGround();

    // ステ
    STATIONS.forEach(s=>{
      const p=iso(s.x,s.y);
      ctx.fillStyle="rgba(255,255,255,.18)";
      ctx.beginPath();
      ctx.arc(p.sx,p.sy,4,0,Math.PI*2);
      ctx.fill();
    });

    // 固定施設
    FIXED.sort((a,b)=>(a.x+a.y)-(b.x+b.y)).forEach(b=>{
      const p=iso(b.x,b.y);
      ctx.fillStyle=b.type==="sun"?"#ff8a1a":b.type==="fort"?"#19c37d":"#2b7cff";
      ctx.fillRect(p.sx-8,p.sy-16,16,16);
      if(b.label){
        ctx.fillStyle="#fff";
        ctx.font="12px system-ui";
        ctx.textAlign="center";
        ctx.fillText(b.label,p.sx,p.sy-18);
      }
    });

    // HQ
    hqs.forEach(h=>{
      const p=iso(h.x,h.y);
      ctx.fillStyle=h.color;
      ctx.fillRect(p.sx-10,p.sy-20,20,20);
      ctx.fillStyle="#fff";
      ctx.fillText(h.label,p.sx,p.sy-24);
    });

    ctx.restore();
  }

  /* ===== 初期位置：太陽城を中央に ===== */
  function centerOnSun(){
    const p = iso(SUN.x, SUN.y);
    cam.x = -p.sx;
    cam.y = -p.sy;
    cam.s = 1;
  }

  /* ===== UI ===== */
  document.getElementById("addHQ").onclick=()=>{
    hqs.push({
      id:nextHqId++,
      x:SUN.x+40,
      y:SUN.y+40,
      label:document.getElementById("hqLabel").value,
      color:document.getElementById("hqColor").value
    });
    draw();
  };
  document.getElementById("reset").onclick=()=>{
    centerOnSun();
    draw();
  };

  /* ===== 起動（iOS安定） ===== */
  function boot(){
    centerOnSun();           // ← ここで必ず太陽城を見る
    setTimeout(draw, 300);   // ← iOS Safari 対策
  }
  window.addEventListener("resize", ()=>setTimeout(draw,200));
  boot();
})();
</script>

</body>
</html>