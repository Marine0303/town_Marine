<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>ステ繋げシミュレーション</title>
<style>
  :root{
    --pad:12px;
    --safeTop: env(safe-area-inset-top);
    --safeBot: env(safe-area-inset-bottom);
    --hdrH: 56px;
  }
  html,body{
    margin:0;height:100%;
    background:#050b1a;color:#e9eefc;
    font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
    overflow:hidden;
  }
  header{
    position:fixed;left:0;right:0;top:0;z-index:50;
    height: calc(var(--hdrH) + var(--safeTop));
    padding-top: var(--safeTop);
    background: rgba(8,14,34,.92);
    border-bottom:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    display:flex;align-items:center;gap:10px;
    padding-left: var(--pad);padding-right: var(--pad);
    box-sizing: border-box;
  }
  .btn{
    background:#0f1b44;color:#e9eefc;
    border:1px solid rgba(255,255,255,.18);
    border-radius:14px;
    padding:10px 12px;font-size:14px;cursor:pointer;
  }
  .btn.primary{
    background: linear-gradient(180deg, rgba(50,120,255,.95), rgba(40,90,230,.95));
    font-weight:900;
  }
  .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sp{flex:1}
  .pill{
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.05);
    font-size:12px;
  }
  #c{
    position:fixed;left:0;right:0;
    top: calc(var(--hdrH) + var(--safeTop));
    bottom: calc(44px + var(--safeBot));
    touch-action:none;background:#050b1a;
  }
  .hud{
    position:fixed;left:0;right:0;bottom:0;
    padding:10px var(--pad) calc(10px + var(--safeBot));
    background: rgba(8,14,34,.86);
    border-top:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    display:flex;gap:10px;align-items:center;z-index:40;
  }
  .hud .box{
    flex:1;border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    border-radius:14px;padding:10px;font-size:12px;
  }
  .hud .big{font-size:13px;font-weight:900}
  .hud .muted{opacity:.75}
  #toast{
    position:fixed;left:50%;bottom: calc(68px + var(--safeBot));
    transform: translateX(-50%);
    background: rgba(0,0,0,.72);color:#fff;
    padding:10px 14px;border-radius:999px;font-size:13px;
    opacity:0;pointer-events:none;transition: opacity .18s ease;z-index:120;
  }
  #toast.show{opacity:1}
</style>
</head>
<body>

<header>
  <button id="menuBtn" class="btn">☰</button>
  <div class="title">WOS 旗ルート</div>
  <div class="sp"></div>
  <span id="selPill" class="pill">選択 0</span>
  <button id="routeBtn" class="btn primary">ルート</button>
</header>

<canvas id="c"></canvas>

<div class="hud">
  <div class="box">
    <div class="big">タップ座標</div>
    <div id="tapXY" class="muted">X: -  /  Y: -</div>
  </div>
  <div class="box">
    <div class="big">HQ</div>
    <div id="hqXY" class="muted">X: 520 / Y: 520</div>
  </div>
  <button id="fullBtn" class="btn">全体</button>
  <button id="resetBtn" class="btn">リセット</button>
</div>

<div id="toast"></div>

<script>
(() => {
  // ===== 基本 =====
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;

  const toastEl = document.getElementById("toast");
  const toast = (m)=>{ toastEl.textContent=m; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),900); };

  // ===== Effect 定義（ここ1か所だけ）=====
  const EFFECT_MASTER = {
    prod:  { name:"生産",   color:"#22c55e", levels:[1] },
    gath:  { name:"採集",   color:"#a3e635", levels:[1] },
    build: { name:"建築",   color:"#0ea5e9", levels:[1,3] },
    tech:  { name:"技術",   color:"#8b5cf6", levels:[1,3] },
    train: { name:"訓練",   color:"#06b6d4", levels:[2] },
    march: { name:"遠征",   color:"#38bdf8", levels:[3] },
    atk:   { name:"武器",   color:"#ef4444", levels:[2,4] },
    def:   { name:"防御",   color:"#f59e0b", levels:[2,4] },
  };
  const EFFECTS = Object.entries(EFFECT_MASTER).map(([id,v])=>({id,name:v.name,color:v.color}));
  const effectById = Object.fromEntries(EFFECTS.map(e=>[e.id,e]));
  function makeLabel(id,lv){
    const n = EFFECT_MASTER[id].name;
    if(id==="atk"||id==="def"){ if(lv===2) return `${n} 5%`; if(lv===4) return `${n} 8%`; }
    return `${n} Lv${lv}`;
  }
  const EFFECT_LEVELS = Object.entries(EFFECT_MASTER).flatMap(([id,v]) =>
    v.levels.map(lv=>({ key:`${id}:${lv}`, effectId:id, lv, label:makeLabel(id,lv), color:v.color }))
  );
  const elByKey = Object.fromEntries(EFFECT_LEVELS.map(x=>[x.key,x]));

  // ===== World =====
  const WORLD_MIN=0, WORLD_MAX=1200;
  const SCALE=0.85, TILE_W=42, TILE_H=22;
  const SUN={x:597,y:597};
  const NO_PASS={x1:497,y1:497,x2:697,y2:697};

  function iso(x,y){ return {sx:(x-y)*SCALE, sy:(x+y)*SCALE*0.5}; }

  const cam={x:0,y:0,s:1}, BASE={x:0,y:0};

  function resize(){
    const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);
    canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    BASE.x=r.width/2; BASE.y=r.height/2;
  }

  function centerOn(x,y){ const p=iso(x,y); cam.x=-p.sx*cam.s; cam.y=-p.sy*cam.s; }

  // ===== 仮ステーション =====
  const STATIONS_RAW=[[138,327],[138,957],[237,138],[327,1038],[768,138],[957,1068]];
  let stations = STATIONS_RAW.map(([x,y],i)=>({sid:i+1,key:`S${i+1}`,x,y,effectId:EFFECTS[i%EFFECTS.length].id,lv:1}));

  // ===== HQ =====
  const HQ={x:520,y:520};
  document.getElementById("hqXY").textContent=`X: ${HQ.x} / Y: ${HQ.y}`;

  // ===== 描画 =====
  function draw(){
    resize();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.save();
    ctx.translate(BASE.x+cam.x, BASE.y+cam.y);
    ctx.scale(cam.s, cam.s);

    // 背景
    ctx.fillStyle="#050b1a";
    ctx.fillRect(-99999,-99999,199998,199998);

    // ステ
    for(const s of stations){
      const p=iso(s.x,s.y);
      const eff=effectById[s.effectId];
      ctx.fillStyle=eff.color;
      ctx.beginPath(); ctx.arc(p.sx,p.sy,6,0,Math.PI*2); ctx.fill();
    }

    // HQ
    const ph=iso(HQ.x,HQ.y);
    ctx.fillStyle="#2b7cff";
    ctx.beginPath(); ctx.arc(ph.sx,ph.sy,9,0,Math.PI*2); ctx.fill();

    ctx.restore();
  }

  // ===== UI =====
  document.getElementById("fullBtn").onclick=()=>{ cam.s=1; centerOn(600,600); draw(); toast("全体"); };
  document.getElementById("resetBtn").onclick=()=>{ cam.s=1; centerOn(SUN.x,SUN.y); draw(); toast("リセット"); };
  document.getElementById("routeBtn").onclick=()=>{ toast("ルート（デモ）"); };

  // ===== 起動 =====
  window.addEventListener("resize", draw);
  centerOn(SUN.x,SUN.y);
  draw();
})();
</script>

</body>
</html>